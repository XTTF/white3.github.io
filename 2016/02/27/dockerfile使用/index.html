<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>DockerFile使用 | 麦芽屋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="BUG与性能向的Dockerfile">
<meta name="keywords" content="docker">
<meta property="og:type" content="article">
<meta property="og:title" content="DockerFile使用">
<meta property="og:url" content="white3.github.io/2016/02/27/dockerfile使用/index.html">
<meta property="og:site_name" content="麦芽屋">
<meta property="og:description" content="BUG与性能向的Dockerfile">
<meta property="og:locale" content="default">
<meta property="og:image" content="c:/Users/Menzel3/AppData/Local/Temp/1533272277002.png">
<meta property="og:image" content="c:/Users/Menzel3/AppData/Local/Temp/1533272348875.png">
<meta property="og:image" content="c:/Users/Menzel3/AppData/Local/Temp/1533273009335.png">
<meta property="og:image" content="c:/Users/Menzel3/AppData/Local/Temp/1533272815727.png">
<meta property="og:image" content="c:/Users/Menzel3/AppData/Local/Temp/1533273093159.png">
<meta property="og:image" content="c:/Users/Menzel3/AppData/Local/Temp/1533273350699.png">
<meta property="og:image" content="c:/Users/Menzel3/AppData/Local/Temp/1533273671924.png">
<meta property="og:image" content="c:/Users/Menzel3/AppData/Local/Temp/1533273955031.png">
<meta property="og:updated_time" content="2018-08-06T01:29:10.175Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DockerFile使用">
<meta name="twitter:description" content="BUG与性能向的Dockerfile">
<meta name="twitter:image" content="c:/Users/Menzel3/AppData/Local/Temp/1533272277002.png">
  
    <link rel="alternate" href="/atom.xml" title="麦芽屋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">麦芽屋</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">有趣的恶魔,无趣的枷锁</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="white3.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-dockerfile使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/27/dockerfile使用/" class="article-date">
  <time datetime="2016-02-27T00:00:00.000Z" itemprop="datePublished">2016-02-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      DockerFile使用
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>BUG与性能向的Dockerfile</strong></p>
<a id="more"></a>
<h1 id="Dockerfile使用"><a href="#Dockerfile使用" class="headerlink" title="Dockerfile使用"></a>Dockerfile使用</h1><h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h3><p>两步完成</p>
<ul>
<li>创建文件夹，进入文件夹书写Dockerfile文件(<strong>文件名可以不为Dockerfile</strong>)</li>
<li>使用<code>docker build &lt;参数&gt;</code>命令构建镜像，完成后可以使用<code>docker images</code>查看</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build [选项] &lt;上下文路径/URL/-&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir Jenkins</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> Jenkins</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim Dockerfile</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker build -t 镜像名称 .</span></span><br></pre></td></tr></table></figure>
<p><img src="C:\Users\Menzel3\AppData\Local\Temp\1533272277002.png" alt="1533272277002"></p>
<h4 id="其他构建方式"><a href="#其他构建方式" class="headerlink" title="其他构建方式"></a>其他构建方式</h4><p><strong>直接用 Git repo 进行构建</strong></p>
<p>或许你已经注意到了，<code>docker build</code> 还支持从 URL 构建，比如可以直接从 Git repo 中构建：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker build https://github.com/twang2218/gitlab-ce-zh.git<span class="comment">#:10.7</span></span></span><br></pre></td></tr></table></figure>
<p>这行命令指定了构建所需的 Git repo，并且指定默认的 <code>master</code> 分支，构建目录为 <code>/10.7/</code>，然后 Docker 就会自己去 <code>git clone</code> 这个项目、切换到指定分支、并进入到指定目录后开始构建。</p>
<p><img src="C:\Users\Menzel3\AppData\Local\Temp\1533272348875.png" alt="1533272348875"></p>
<p><strong>用给定的 tar 压缩包构建</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build http://server/context.tar.gz</span><br></pre></td></tr></table></figure>
<p>如果所给出的 URL 不是个 Git repo，而是个 <code>tar</code> 压缩包，那么 Docker 引擎会下载这个包，并自动解压缩，以其作为上下文，开始构建。</p>
<p><strong>从标准输入中读取 Dockerfile 进行构建</strong>(有缺陷)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build - &lt; Dockerfile 或 cat Dockerfile | docker build -</span><br></pre></td></tr></table></figure>
<p>缺点：不可以像其他方法那样可以将本地文件 <code>COPY</code> 进镜像之类的事情。</p>
<p><strong>从标准输入中读取上下文压缩包进行构建</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build - &lt; context.tar.gz</span><br></pre></td></tr></table></figure>
<p>如果发现标准输入的文件格式是 <code>gzip</code>、<code>bzip2</code> 以及 <code>xz</code> 的话，将会使其为上下文压缩包，直接将其展开，将里面视为上下文，并开始构建。</p>
<h1 id="Dockerfile书写"><a href="#Dockerfile书写" class="headerlink" title="Dockerfile书写"></a>Dockerfile书写</h1><p>语法格式</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构架装有curl的ubuntu镜像</span></span><br><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 作者信息</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> menzel3 <span class="string">"233333@m.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装curl</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y curl</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">EXPOSE 80</span></span><br></pre></td></tr></table></figure>
<h4 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h4><p>依赖的基础镜像</p>
<h4 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h4><p><code>EXPOSE</code> 和在运行时使用 <code>-p &lt;宿主端口&gt;:&lt;容器端口&gt;</code> 区分开来。<code>-p</code>，是映射宿主端口和容器端口，<code>EXPOSE</code> 仅仅是声明容器打算使用什么端口而已，并不会自动在宿主进行端口映射。 </p>
<p><strong>注意</strong>：<strong>只有声明过的端口才能被映射</strong></p>
<h4 id="CMD-amp-RUN-amp-ENTRYPOINT"><a href="#CMD-amp-RUN-amp-ENTRYPOINT" class="headerlink" title="CMD&amp;RUN&amp;ENTRYPOINT"></a>CMD&amp;RUN&amp;<strong>ENTRYPOINT</strong></h4><p><code>CMD</code> 指令的格式与 <code>RUN</code> 相似，都是两种格式：</p>
<ul>
<li><code>shell</code> 格式：<code>CMD &lt;命令&gt;</code> 与<code>RUN &lt;命令&gt;</code> </li>
<li><code>exec</code> 格式：<code>CMD [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;...]</code> 与 <code>RUN [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;...]</code></li>
<li>传入的命令和参数会被解析为JSON 数组，请务必使用 “ 写入参数</li>
</ul>
<p>区别：</p>
<p>CMD指令为容器主进程开启后的默认执行命令，如果启动容器时指定了 <code>ENTRYPOINT</code> 指令后，用 <code>CMD</code> 命令将被覆盖。ENTRYPOINT比CMD功能多在不会被覆盖，而是追加命令。</p>
<p>RUN为构建镜像命令`</p>
<h4 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h4><p>格式为 <code>WORKDIR &lt;工作目录路径&gt;</code>。</p>
<p>使用 <code>WORKDIR</code> 指令可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，<code>WORKDIR</code> 会帮你建立目录。</p>
<p><strong>易错点</strong>：把 <code>Dockerfile</code> 等同于 Shell 脚本 </p>
<h4 id="ENV-amp-ARG"><a href="#ENV-amp-ARG" class="headerlink" title="ENV&amp;ARG"></a>ENV&amp;ARG</h4><p>设置环境变量</p>
<p><strong>区别</strong>：ARG为所设置的构建环境的环境变量，构建完成即失效。(history命令能查看值)</p>
<h4 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h4><p>格式：<code>USER &lt;用户名&gt;</code></p>
<p><code>USER</code> 指令和 <code>WORKDIR</code> 相似，都是改变环境状态并影响以后的层。<code>WORKDIR</code> 是改变工作目录，<code>USER</code> 则是改变之后层的执行 <code>RUN</code>, <code>CMD</code> 以及 <code>ENTRYPOINT</code> 这类命令的身份。</p>
<h4 id="COPY-amp-ADD"><a href="#COPY-amp-ADD" class="headerlink" title="COPY&amp;ADD"></a>COPY&amp;ADD</h4><p>格式：</p>
<ul>
<li><code>COPY &lt;源路径&gt;... &lt;目标路径&gt;</code></li>
<li><code>COPY [&quot;&lt;源路径1&gt;&quot;,... &quot;&lt;目标路径&gt;&quot;]</code></li>
</ul>
<p>使用 <code>COPY</code> 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。 </p>
<p>而<strong>ADD</strong>为加强版的<strong>COPY</strong>，附加的功能为</p>
<ul>
<li>源路径可以是URL</li>
<li>具有自解压缩功能</li>
</ul>
<p><strong>注意</strong>：</p>
<ol>
<li>路径可以是通配符 ，需满足Go的正则语法</li>
<li>尽可能使用COPY，ADD命令虽然功能丰富，但是其功能处于黑盒状态，且效率略低于直接COPY</li>
</ol>
<h4 id="ONBUILD"><a href="#ONBUILD" class="headerlink" title="ONBUILD"></a>ONBUILD</h4><p>格式：<code>ONBUILD &lt;其它指令&gt;</code>。</p>
<p><code>ONBUILD</code> 是一个特殊的指令，它后面跟的是其它指令，比如 <code>RUN</code>, <code>COPY</code> 等，而这些指令，在当前镜像构建时并不会被执行。只有当以当前镜像为基础镜像，去构建下一级镜像的时候才会被执行。</p>
<p><strong>VOLUMES</strong></p>
<p>创建一个挂在点，可以从本机或其他容器挂载的挂载点。</p>
<p>大白话：从容器中暴露出一部分，和外界共享，一般放数据库的数据或者是代码。</p>
<p>难点：<strong>权限问题</strong></p>
<p>volume挂载的目录默认属于root用户，如果没有chown给其他用户的话，在Volume卷中创建的文件和文件夹将具有与在容器中创建它们的用户相同的uid:gid(数字)。</p>
<p>问题场景：使用 -v 选项将容器内容挂载到主系统下，默认所属组和用户为root，这时候如果容器内的执行权限低于root，你会发现一堆异常。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> debian:jessie</span><br><span class="line"></span><br><span class="line"><span class="comment"># add our user and group first to make sure their IDs get assigned consistently, regardless of whatever dependencies get added</span></span><br><span class="line"><span class="comment">#RUN groupadd -r www-data &amp;&amp; useradd -r --create-home -g www-data www-data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> HTTPD_PREFIX /usr/local/apache2</span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:$HTTPD_PREFIX/bin</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p <span class="string">"<span class="variable">$HTTPD_PREFIX</span>"</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chown www-data:www-data <span class="string">"<span class="variable">$HTTPD_PREFIX</span>"</span></span></span><br><span class="line"><span class="bash">WORKDIR <span class="variable">$HTTPD_PREFIX</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># install httpd runtime dependencies</span></span></span><br><span class="line"><span class="bash"><span class="comment"># https://httpd.apache.org/docs/2.4/install.html#requirements</span></span></span><br><span class="line"><span class="bash">RUN apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y --no-install-recommends \</span></span><br><span class="line"><span class="bash">        libapr1 \</span></span><br><span class="line"><span class="bash">        libaprutil1 \</span></span><br><span class="line"><span class="bash">        libaprutil1-ldap \</span></span><br><span class="line"><span class="bash">        libapr1-dev \</span></span><br><span class="line"><span class="bash">        libaprutil1-dev \</span></span><br><span class="line"><span class="bash">        libpcre++0 \</span></span><br><span class="line"><span class="bash">        libssl1.0.0 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -r /var/lib/apt/lists/*</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENV HTTPD_VERSION 2.4.20</span></span><br><span class="line"><span class="bash">ENV HTTPD_BZ2_URL https://www.apache.org/dist/httpd/httpd-<span class="variable">$HTTPD_VERSION</span>.tar.bz2</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN buildDeps=<span class="string">' \</span></span></span><br><span class="line"><span class="bash">        ca-certificates \</span></span><br><span class="line"><span class="bash">        curl \</span></span><br><span class="line"><span class="bash">        bzip2 \</span></span><br><span class="line"><span class="bash">        gcc \</span></span><br><span class="line"><span class="bash">        libpcre++-dev \</span></span><br><span class="line"><span class="bash">        libssl-dev \</span></span><br><span class="line"><span class="bash">        make \</span></span><br><span class="line"><span class="bash">    <span class="string">' \</span></span></span><br><span class="line"><span class="bash">    <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y --no-install-recommends <span class="variable">$buildDeps</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -r /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fSL <span class="string">"<span class="variable">$HTTPD_BZ2_URL</span>"</span> -o httpd.tar.bz2 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fSL <span class="string">"<span class="variable">$HTTPD_BZ2_URL</span>.asc"</span> -o httpd.tar.bz2.asc \</span></span><br><span class="line"><span class="bash"><span class="comment"># see https://httpd.apache.org/download.cgi#verify</span></span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">export</span> GNUPGHOME=<span class="string">"<span class="variable">$(mktemp -d)</span>"</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; gpg --keyserver ha.pool.sks-keyservers.net --recv-keys A93D62ECC3C8EA12DB220EC934EA76E6791485A8 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; gpg --batch --verify httpd.tar.bz2.asc httpd.tar.bz2 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -r <span class="string">"<span class="variable">$GNUPGHOME</span>"</span> httpd.tar.bz2.asc \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -xvf httpd.tar.bz2 -C src --strip-components=1 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm httpd.tar.bz2 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> src \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./configure \</span></span><br><span class="line"><span class="bash">        --prefix=<span class="string">"<span class="variable">$HTTPD_PREFIX</span>"</span> \</span></span><br><span class="line"><span class="bash">        --<span class="built_in">enable</span>-mods-shared=reallyall \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make -j<span class="string">"<span class="variable">$(nproc)</span>"</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> .. \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -r src \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -ri \</span></span><br><span class="line"><span class="bash">        -e <span class="string">'s!^(\s*CustomLog)\s+\S+!\1 /proc/self/fd/1!g'</span> \</span></span><br><span class="line"><span class="bash">        -e <span class="string">'s!^(\s*ErrorLog)\s+\S+!\1 /proc/self/fd/2!g'</span> \</span></span><br><span class="line"><span class="bash">        <span class="string">"<span class="variable">$HTTPD_PREFIX</span>/conf/httpd.conf"</span> \</span></span><br><span class="line"><span class="bash">    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get purge -y --auto-remove <span class="variable">$buildDeps</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">COPY httpd-foreground /usr/<span class="built_in">local</span>/bin/</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">EXPOSE 80</span></span><br><span class="line"><span class="bash">CMD [<span class="string">"httpd-foreground"</span>]</span></span><br></pre></td></tr></table></figure>
<h3 id="构建过程"><a href="#构建过程" class="headerlink" title="构建过程"></a>构建过程</h3><p>构建</p>
<p><img src="C:\Users\Menzel3\AppData\Local\Temp\1533273009335.png" alt="1533273009335"></p>
<p>缓存(可以–no-cache)</p>
<p>完事儿</p>
<h2 id="Docker优化"><a href="#Docker优化" class="headerlink" title="Docker优化"></a>Docker优化</h2><h3 id="阶段性调试"><a href="#阶段性调试" class="headerlink" title="阶段性调试"></a>阶段性调试</h3><p><img src="C:\Users\Menzel3\AppData\Local\Temp\1533272815727.png" alt="1533272815727"></p>
<p>我们查看一下Dockerfile内容</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构架装有curl的ubuntu镜像</span></span><br><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 作者信息</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> menzel3 <span class="string">"233333@m.com"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> wget www.menzel3.fun &gt; /var/www/html/index.html</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">EXPOSE 80</span></span><br></pre></td></tr></table></figure>
<p><img src="C:\Users\Menzel3\AppData\Local\Temp\1533273093159.png" alt="1533273093159"></p>
<p>我们给这个中间层镜像一个标签</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag c262876003c2 docker_debug</span><br></pre></td></tr></table></figure>
<p>进入镜像调试bug</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mzl@ubuntu:~/docker/Nginx$ docker run -it --name docker_bug docker_debug /bin/bash</span><br><span class="line">root@313292ae9385:/# wget www.menzel3.fun &gt; /var/www/html/index.html</span><br><span class="line">bash: /var/www/html/index.html: No such file or directory</span><br></pre></td></tr></table></figure>
<p><img src="C:\Users\Menzel3\AppData\Local\Temp\1533273350699.png" alt="1533273350699"></p>
<p>修改Dockerfile文件，然后build到成功为止</p>
<h3 id="多阶段构建"><a href="#多阶段构建" class="headerlink" title="多阶段构建"></a>多阶段构建</h3><p>缺点：管理Dockerfile与数据卷</p>
<p>优点：优化镜像大小</p>
<p>下面再Dockerfile文件中使用多阶段构建；<br>　　<strong>1、该Dockerfile中有两个FROM为两步构建，在Maven基础镜像中编译生成Jar、依赖，这阶段命名为：BUILD</strong><br>　　<strong>2、使用linx/alpine-jdk8:0.1作为基础镜像，设置环境、创建目录，更重要的是使用COPY –from把BUILD阶段生成的项目文件拷贝到镜像中；</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.5</span>-jdk-<span class="number">8</span> as BUILD</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src /usr/app/src</span></span><br><span class="line"><span class="bash">COPY pom.xml /usr/app</span></span><br><span class="line"><span class="bash">COPY ./docker/start.sh /usr/app/</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN mvn -f /usr/app/pom.xml clean package  -U -Dmaven.test.skip=<span class="literal">true</span></span></span><br><span class="line"><span class="bash">RUN mvn -f /usr/app/pom.xml dependency:copy-dependencies</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">FROM linx/alpine-jdk8:0.1</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># 设置locale</span></span></span><br><span class="line"><span class="bash">ENV LANG en_US.UTF-8</span></span><br><span class="line"><span class="bash">ENV LANGUAGE en_US:en</span></span><br><span class="line"><span class="bash">ENV LC_ALL en_US.UTF-8</span></span><br><span class="line"><span class="bash">ENV TZ=Asia/Shanghai</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN mkdir /app_home</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">WORKDIR /app_home</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">COPY --from=BUILD /usr/app/target/nettyDemo-1.0-SNAPSHOT.jar /app_home</span></span><br><span class="line"><span class="bash">COPY --from=BUILD /usr/app/target/dependency /app_home/dependency</span></span><br><span class="line"><span class="bash">COPY --from=BUILD /usr/app/start.sh /app_home</span></span><br><span class="line"><span class="bash">COPY ./docker/start.sh /app_home/</span></span><br><span class="line"><span class="bash">RUN chmod +x /app_home/start.sh</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">CMD  /app_home/start.sh</span></span><br></pre></td></tr></table></figure>
<h2 id="Docker缺陷"><a href="#Docker缺陷" class="headerlink" title="Docker缺陷"></a>Docker缺陷</h2><h3 id="兼容问题"><a href="#兼容问题" class="headerlink" title="兼容问题"></a>兼容问题</h3><p>我们都知道Docker与虚拟机的一个区别就是，Docker与宿主公用一个操作系统内核，在内核及用户空间中运行不兼容或者未经测试的<a href="https://zh.wikipedia.org/wiki/GNU_C%E5%87%BD%E5%BC%8F%E5%BA%AB">glibc</a>组合版本很可能引发意料之外的行为。 </p>
<h3 id="内存问题"><a href="#内存问题" class="headerlink" title="内存问题"></a>内存问题</h3><p>某一个场景，内存充足，但是系统提示 <code>No space left on device</code>(磁盘空间不足)</p>
<p><img src="C:\Users\Menzel3\AppData\Local\Temp\1533273671924.png" alt="1533273671924"></p>
<p>通过命令 <code>sudo dumpe2fs -h /dev/sda1</code> 查看某个盘符空闲<code>inode</code>节点与<code>block</code>块</p>
<p><img src="C:\Users\Menzel3\AppData\Local\Temp\1533273955031.png" alt="1533273955031"></p>
<p><a href="http://www.dockerinfo.net/3889.html">参考链接</a></p>
<h3 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h3><p>当有一个docker镜像服务沦为肉鸡，那么会发生什么事情呢？</p>
<h4 id="Docker源问题"><a href="#Docker源问题" class="headerlink" title="Docker源问题"></a><strong>Docker源问题</strong></h4><p>Docker提供了docker hub可以让用户上传创建的镜像，以便其他用户下载，快速搭建环境。但同时也带来了一些安全问题。下载的镜像被恶意植入后门，传输的过程中镜像被篡改， 镜像所搭建的环境是否本身就包含漏洞等等，不一而足。主要介绍下面三种：</p>
<p><strong>1.黑客上传恶意镜像</strong></p>
<p>如果有黑客在制作的镜像中植入木马，后门等恶意软件，那么环境从一开始就已经不安全了，后续更没有什么安全可言。</p>
<p><strong>2.镜像使用有漏洞的软件</strong></p>
<p>据一些报告显示，hub上能下载的镜像里面，75%的镜像都安装了有漏洞的软件，所以下载镜像后，需要检查里面软件的版本信息，对应的版本是否存在漏洞，并及时更新打上补丁。</p>
<p><strong>3.中间人攻击篡改镜像</strong></p>
<p>镜像在传输过程中可能被篡改，目前新版本的Docker已经提供了相应的校验机制来预防这个问题。</p>
<p>####Docker架构缺陷与安全机制</p>
<p><strong>容器之间的局域网攻击</strong></p>
<p>同一主机上的容器之间可以构成局域网，因此针对局域网的ARP欺骗，嗅探，广播风暴等攻击方式便可以用上。所以在一个主机上部署多个容器需要合理的配置网络，设置iptable规则。</p>
<p><strong>DDoS攻击耗尽资源</strong></p>
<p>cgroups安全机制就是要防止此类攻击的，不要为单一的容器分配过多的资源即可避免此类问题。</p>
<p><strong>调用有漏洞的系统调用</strong></p>
<p>我们都知道Docker与虚拟机的一个区别就是，Docker与宿主公用一个操作系统内核，一旦宿主内核存在可以横向越权或者提权漏洞，那么尽管Docker使用普通用户执行，一旦容器被入侵，攻击者还是可以利用内核漏洞逃逸到宿主，做更多事情。</p>
<p><strong>共享root</strong></p>
<p>如果以root权限运行容器，容器内的root用户也就拥有了宿主机的root权限。</p>
<p><strong>未隔离的文件系统</strong></p>
<p>虽然Docker已经对文件系统进行隔离，但是有一些重要的系统文件暂时没有被隔离，如/sys, /proc/sys, /proc/bus等。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="white3.github.io/2016/02/27/dockerfile使用/" data-id="cjkwbsim30011f4jtedo6x5ua" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/02/27/binwalk使用教程/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
    <a href="/2016/02/27/sqlmap使用教程/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF杂项/">CTF杂项</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CURL/">CURL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSP/">JSP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MIPS汇编/">MIPS汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MYSQL/">MYSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/">Maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PWN/">PWN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/install/">install</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/question/">question</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web安全/">web安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/二进制/">二进制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内网/">内网</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/基础/">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/安装/">安装</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小文/">小文</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/扫描/">扫描</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模板/">模板</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/笔记/">笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编码/">编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程/">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/配置/">配置</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF杂项/" style="font-size: 10px;">CTF杂项</a> <a href="/tags/CURL/" style="font-size: 10px;">CURL</a> <a href="/tags/JSP/" style="font-size: 10px;">JSP</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/MIPS汇编/" style="font-size: 10px;">MIPS汇编</a> <a href="/tags/MYSQL/" style="font-size: 10px;">MYSQL</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/PWN/" style="font-size: 10px;">PWN</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/install/" style="font-size: 10px;">install</a> <a href="/tags/question/" style="font-size: 10px;">question</a> <a href="/tags/web安全/" style="font-size: 15px;">web安全</a> <a href="/tags/二进制/" style="font-size: 10px;">二进制</a> <a href="/tags/内网/" style="font-size: 10px;">内网</a> <a href="/tags/基础/" style="font-size: 10px;">基础</a> <a href="/tags/安装/" style="font-size: 10px;">安装</a> <a href="/tags/小文/" style="font-size: 10px;">小文</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/扫描/" style="font-size: 10px;">扫描</a> <a href="/tags/模板/" style="font-size: 20px;">模板</a> <a href="/tags/笔记/" style="font-size: 10px;">笔记</a> <a href="/tags/编码/" style="font-size: 15px;">编码</a> <a href="/tags/编程/" style="font-size: 10px;">编程</a> <a href="/tags/配置/" style="font-size: 10px;">配置</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/08/16/mysql/">MYSQL的学习</a>
          </li>
        
          <li>
            <a href="/2018/08/16/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2018/08/02/Linux的inode号/">Linux/unix上神奇的inode编号</a>
          </li>
        
          <li>
            <a href="/2018/07/29/PUNYCODE编码协议/">PUNYCODE</a>
          </li>
        
          <li>
            <a href="/2018/07/29/docker/">Docker基础学习</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Menzel3<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>